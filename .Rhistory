qtr=paste(i),
slice="area", # "industry", "area", or "size."
sliceCode="US000") %>%
mutate(fips = area_fips) %>%
filter(own_code == 5)
}
for(i in 1:4){
data_2018[[i]] <- qcew_api(year = 2018,
qtr=paste(i),
slice="area", # "industry", "area", or "size."
sliceCode="US000") %>%
mutate(fips = area_fips) %>%
filter(own_code == 5)
}
QCEW_National <- rbind(do.call(rbind, data_2022),
do.call(rbind, data_2021),
do.call(rbind, data_2020),
do.call(rbind, data_2019),
do.call(rbind, data_2018))
##########################################################################
QCEW_National <- QCEW_National %>%
mutate(year_quarter = paste0(year,"-",qtr),
year_quarter_num = year + qtr/4,
label = if_else(year_quarter_num == max(year_quarter_num), as.character(industry_code), NA_character_)) %>%
filter(industry_code!="99")
QCEW_National %>%
filter(as.numeric(as.character(industry_code))<100 & industry_code!="10") %>%
ggplot(aes(x = year_quarter,
y = qtrly_estabs,
group = industry_code,
color = industry_code)) +
geom_point() +
geom_line() +
geom_label_repel(aes(label = label),
nudge_x = 1,
na.rm = TRUE) +
labs(title = "Quarterly Establishments, Private Workers") +
ylab("Establishments") +
xlab("Year-Quarter") +
theme(legend.position = "right",
plot.title = element_text(size=14),
legend.title = element_text(size=12),
panel.background = element_rect(color = "transparent",
fill = "transparent")) +
guides(color = FALSE)
QCEW_National %>%
filter(as.numeric(as.character(industry_code))<100 & industry_code!="10") %>%
ggplot(aes(x = year_quarter,
y = month3_emplvl/1000,
group = industry_code,
color = industry_code)) +
geom_point() +
geom_line() +
geom_label_repel(aes(label = label),
nudge_x = 1,
segment.curvature = -0.1,
segment.ncp = 3,
segment.angle = 20,
segment.linetype = 3,
na.rm = TRUE) +
labs(title = "National Employment by two-digit NAICS, Private Workers") +
ylab("Month 3 Employment per Quarter (Thousands)") +
xlab("Year-Quarter") +
scale_y_continuous(labels = comma) +
theme(legend.position = "right",
plot.title = element_text(size=14),
legend.title = element_text(size=12),
panel.background = element_rect(color = "transparent",
fill = "transparent")) +
guides(color = FALSE)
##########################################################################
estab <- QCEW_National %>%
filter(as.numeric(as.character(industry_code))<100) %>%
filter(year_quarter_num == max(year_quarter_num)) %>%
select(industry_code,
oty_qtrly_estabs_chg,oty_qtrly_estabs_pct_chg) %>%
rename("Level" = "oty_qtrly_estabs_chg",
"Percent" = "oty_qtrly_estabs_pct_chg") %>%
mutate(Group = "Change in Estab.")
emp <- QCEW_National %>%
filter(as.numeric(as.character(industry_code))<100) %>%
filter(year_quarter_num == max(year_quarter_num)) %>%
select(industry_code,
oty_month3_emplvl_chg,oty_month3_emplvl_pct_chg)%>%
rename("Level" = "oty_month3_emplvl_chg",
"Percent" = "oty_month3_emplvl_pct_chg") %>%
mutate(Group = "Change in Employ.")
wage <- QCEW_National %>%
filter(as.numeric(as.character(industry_code))<100) %>%
filter(year_quarter_num == max(year_quarter_num)) %>%
select(industry_code,
oty_avg_wkly_wage_chg,oty_avg_wkly_wage_pct_chg)%>%
rename("Level" = "oty_avg_wkly_wage_chg",
"Percent" = "oty_avg_wkly_wage_pct_chg") %>%
mutate(Group = "Change in Avg. Wage")
change <- rbind(estab,emp,wage)
change %>%
ggplot(aes(y = industry_code,
x = Percent,
fill = Group)) +
geom_col(position = position_dodge(0.8)) +
theme(legend.position = "right",
plot.title = element_text(size=14),
legend.title = element_text(size=12),
panel.background = element_rect(color = "transparent",
fill = "transparent"),
strip.background = element_rect(color = "transparent",
fill = "transparent"),
strip.text = element_text(size=12)) +
labs(title = "Over-the-Year Percent Change, Private Workers") +
ylab("Two-Digit NAICS") +
facet_wrap(Group ~ .) +
guides(fill = FALSE)
change
View(QCEW_National)
?qcew_api
filter(as.numeric(agglvl_code==14 & industry_code!="10") %>%
QCEW_National %>%
filter(agglvl_code==14 & industry_code!="10") %>%
ggplot(aes(x = year_quarter,
y = qtrly_estabs,
group = industry_code,
color = industry_code)) +
geom_point() +
geom_line() +
geom_label_repel(aes(label = label),
nudge_x = 1,
na.rm = TRUE) +
labs(title = "Quarterly Establishments, Private Workers") +
ylab("Establishments") +
xlab("Year-Quarter") +
theme(legend.position = "right",
plot.title = element_text(size=14),
legend.title = element_text(size=12),
panel.background = element_rect(color = "transparent",
fill = "transparent")) +
guides(color = FALSE)
)
QCEW_National %>%
filter(agglvl_code==14 & industry_code!="10") %>%
ggplot(aes(x = year_quarter,
y = qtrly_estabs,
group = industry_code,
color = industry_code)) +
geom_point() +
geom_line() +
geom_label_repel(aes(label = label),
nudge_x = 1,
na.rm = TRUE) +
labs(title = "Quarterly Establishments, Private Workers") +
ylab("Establishments") +
xlab("Year-Quarter") +
theme(legend.position = "right",
plot.title = element_text(size=14),
legend.title = element_text(size=12),
panel.background = element_rect(color = "transparent",
fill = "transparent")) +
guides(color = FALSE)
QCEW_National %>%
filter(agglvl_code==14 & industry_code!="10") %>%
ggplot(aes(x = year_quarter,
y = month3_emplvl/1000,
group = industry_code,
color = industry_code)) +
geom_point() +
geom_line() +
geom_label_repel(aes(label = label),
nudge_x = 1,
segment.curvature = -0.1,
segment.ncp = 3,
segment.angle = 20,
segment.linetype = 3,
na.rm = TRUE) +
labs(title = "National Employment by two-digit NAICS, Private Workers") +
ylab("Month 3 Employment per Quarter (Thousands)") +
xlab("Year-Quarter") +
scale_y_continuous(labels = comma) +
theme(legend.position = "right",
plot.title = element_text(size=14),
legend.title = element_text(size=12),
panel.background = element_rect(color = "transparent",
fill = "transparent")) +
guides(color = FALSE)
##########################################################################
estab <- QCEW_National %>%
filter(agglvl_code==14) %>%
filter(year_quarter_num == max(year_quarter_num)) %>%
select(industry_code,
oty_qtrly_estabs_chg,oty_qtrly_estabs_pct_chg) %>%
rename("Level" = "oty_qtrly_estabs_chg",
"Percent" = "oty_qtrly_estabs_pct_chg") %>%
mutate(Group = "Change in Estab.")
##########################################################################
estab <- QCEW_National %>%
filter(agglvl_code==14) %>%
filter(year_quarter_num == max(year_quarter_num)) %>%
select(industry_code,
oty_qtrly_estabs_chg,oty_qtrly_estabs_pct_chg) %>%
rename("Level" = "oty_qtrly_estabs_chg",
"Percent" = "oty_qtrly_estabs_pct_chg") %>%
mutate(Group = "Change in Estab.")
emp <- QCEW_National %>%
filter(agglvl_code==14) %>%
filter(year_quarter_num == max(year_quarter_num)) %>%
select(industry_code,
oty_month3_emplvl_chg,oty_month3_emplvl_pct_chg)%>%
rename("Level" = "oty_month3_emplvl_chg",
"Percent" = "oty_month3_emplvl_pct_chg") %>%
mutate(Group = "Change in Employ.")
wage <- QCEW_National %>%
filter(agglvl_code==14) %>%
filter(year_quarter_num == max(year_quarter_num)) %>%
select(industry_code,
oty_avg_wkly_wage_chg,oty_avg_wkly_wage_pct_chg)%>%
rename("Level" = "oty_avg_wkly_wage_chg",
"Percent" = "oty_avg_wkly_wage_pct_chg") %>%
mutate(Group = "Change in Avg. Wage")
change <- rbind(estab,emp,wage)
change %>%
ggplot(aes(y = industry_code,
x = Percent,
fill = Group)) +
geom_col(position = position_dodge(0.8)) +
theme(legend.position = "right",
plot.title = element_text(size=14),
legend.title = element_text(size=12),
panel.background = element_rect(color = "transparent",
fill = "transparent"),
strip.background = element_rect(color = "transparent",
fill = "transparent"),
strip.text = element_text(size=12)) +
labs(title = "Over-the-Year Percent Change, Private Workers") +
ylab("Two-Digit NAICS") +
facet_wrap(Group ~ .) +
guides(fill = FALSE)
# Ben Glasner
# Quarterly Census of Employment and Wages Analysis Code
# where does it conflict with CES?
# Geography is interesting
# CEstablihsment trends at the nationalevels
# QCEW job growth vs establishment growth
# QCEW time series of establishment growth at the national level
# include the industry breakdowns as well
# compare to the BFS data?
# BFS vs QCEW shiny app showing trends in establishments by NAICS
# NATIONAL ESTABLISHMENT GROWTH
# share of population (weighted) seeing accelerating or decelerating job growth
##################
###  Library   ###
##################
library(dplyr)
library(usmap)
library(ggplot2)
library(ggforce)
library(ggthemes)
library(gganimate)
library(ggrepel)
library(gifski)
library(scales)
# devtools::install_github("keberwein/blscrapeR", force = TRUE)
library(blscrapeR)
#################
### Set paths ###
#################
if(Sys.info()[["user"]]=="bglasner"){
# Root folder
path_project <- "C:/Users/bglasner/Dropbox"
}
if(Sys.info()[["user"]]=="bngla"){
# Root folder
path_project <- "C:/Users/bngla/Dropbox"
}
if(Sys.info()[["user"]]=="Benjamin Glasner"){
# Root folder
path_project <- "C:/Users/Benjamin Glasner/Dropbox"
}
# Path to saved cohort data
path_qcew <- paste0(path_project,"/GitHub/QCEW")
setwd(path_qcew)
##################################
## QCEW Data Pull
# https://www.bls.gov/cew/about-data/downloadable-file-layouts/quarterly/naics-based-quarterly-layout.htm
data_2022 <- list()
data_2021 <- list()
data_2020 <- list()
data_2019 <- list()
for(i in 1:2){
data_2022[[i]] <- qcew_api(year = 2022,
qtr=paste(i),
slice="industry", # "industry", "area", or "size."
sliceCode=10) %>%
mutate(fips = area_fips) %>%
filter(own_code == 5)
}
for(i in 1:4){
data_2021[[i]] <- qcew_api(year = 2021,
qtr=paste(i),
slice="industry", # "industry", "area", or "size."
sliceCode=10) %>%
mutate(fips = area_fips) %>%
filter(own_code == 5)
}
for(i in 1:4){
data_2020[[i]] <- qcew_api(year = 2020,
qtr=paste(i),
slice="industry", # "industry", "area", or "size."
sliceCode=10) %>%
mutate(fips = area_fips) %>%
filter(own_code == 5)
}
for(i in 1:4){
data_2019[[i]] <- qcew_api(year = 2019,
qtr=paste(i),
slice="industry", # "industry", "area", or "size."
sliceCode=10) %>%
mutate(fips = area_fips) %>%
filter(own_code == 5)
}
QCEW_industry <- rbind(do.call(rbind, data_2022),
do.call(rbind, data_2021),
do.call(rbind, data_2020),
do.call(rbind, data_2019))
##########################################################################
# National
data_2022 <- list()
data_2021 <- list()
data_2020 <- list()
data_2019 <- list()
for(i in 1:2){
data_2022[[i]] <- qcew_api(year = 2022,
qtr=paste(i),
slice="area", # "industry", "area", or "size."
sliceCode="US000") %>%
mutate(fips = area_fips) %>%
filter(own_code == 5)
}
for(i in 1:4){
data_2021[[i]] <- qcew_api(year = 2021,
qtr=paste(i),
slice="area", # "industry", "area", or "size."
sliceCode="US000") %>%
mutate(fips = area_fips) %>%
filter(own_code == 5)
}
for(i in 1:4){
data_2020[[i]] <- qcew_api(year = 2020,
qtr=paste(i),
slice="area", # "industry", "area", or "size."
sliceCode="US000") %>%
mutate(fips = area_fips) %>%
filter(own_code == 5)
}
for(i in 1:4){
data_2019[[i]] <- qcew_api(year = 2019,
qtr=paste(i),
slice="area", # "industry", "area", or "size."
sliceCode="US000") %>%
mutate(fips = area_fips) %>%
filter(own_code == 5)
}
QCEW_National <- rbind(do.call(rbind, data_2022),
do.call(rbind, data_2021),
do.call(rbind, data_2020),
do.call(rbind, data_2019))
##########################################################################
QCEW_National <- QCEW_National %>%
mutate(year_quarter = paste0(year,"-",qtr),
year_quarter_num = year + qtr/4,
label = if_else(year_quarter_num == max(year_quarter_num), as.character(industry_code), NA_character_)) %>%
filter(industry_code!="99")
QCEW_National %>%
filter(agglvl_code==14 & industry_code!="10") %>%
ggplot(aes(x = year_quarter,
y = qtrly_estabs,
group = industry_code,
color = industry_code)) +
geom_point() +
geom_line() +
geom_label_repel(aes(label = label),
nudge_x = 1,
na.rm = TRUE) +
labs(title = "Quarterly Establishments, Private Workers") +
ylab("Establishments") +
xlab("Year-Quarter") +
theme(legend.position = "right",
plot.title = element_text(size=14),
legend.title = element_text(size=12),
panel.background = element_rect(color = "transparent",
fill = "transparent")) +
guides(color = FALSE)
QCEW_National %>%
filter(agglvl_code==14 & industry_code!="10") %>%
ggplot(aes(x = year_quarter,
y = month3_emplvl/1000,
group = industry_code,
color = industry_code)) +
geom_point() +
geom_line() +
geom_label_repel(aes(label = label),
nudge_x = 1,
segment.curvature = -0.1,
segment.ncp = 3,
segment.angle = 20,
segment.linetype = 3,
na.rm = TRUE) +
labs(title = "National Employment by two-digit NAICS, Private Workers") +
ylab("Month 3 Employment per Quarter (Thousands)") +
xlab("Year-Quarter") +
scale_y_continuous(labels = comma) +
theme(legend.position = "right",
plot.title = element_text(size=14),
legend.title = element_text(size=12),
panel.background = element_rect(color = "transparent",
fill = "transparent")) +
guides(color = FALSE)
##########################################################################
estab <- QCEW_National %>%
filter(agglvl_code==14) %>%
filter(year_quarter_num == max(year_quarter_num)) %>%
select(industry_code,
oty_qtrly_estabs_chg,oty_qtrly_estabs_pct_chg) %>%
rename("Level" = "oty_qtrly_estabs_chg",
"Percent" = "oty_qtrly_estabs_pct_chg") %>%
mutate(Group = "Change in Estab.")
emp <- QCEW_National %>%
filter(agglvl_code==14) %>%
filter(year_quarter_num == max(year_quarter_num)) %>%
select(industry_code,
oty_month3_emplvl_chg,oty_month3_emplvl_pct_chg)%>%
rename("Level" = "oty_month3_emplvl_chg",
"Percent" = "oty_month3_emplvl_pct_chg") %>%
mutate(Group = "Change in Employ.")
wage <- QCEW_National %>%
filter(agglvl_code==14) %>%
filter(year_quarter_num == max(year_quarter_num)) %>%
select(industry_code,
oty_avg_wkly_wage_chg,oty_avg_wkly_wage_pct_chg)%>%
rename("Level" = "oty_avg_wkly_wage_chg",
"Percent" = "oty_avg_wkly_wage_pct_chg") %>%
mutate(Group = "Change in Avg. Wage")
change <- rbind(estab,emp,wage)
change %>%
ggplot(aes(y = industry_code,
x = Percent,
fill = Group)) +
geom_col(position = position_dodge(0.8)) +
theme(legend.position = "right",
plot.title = element_text(size=14),
legend.title = element_text(size=12),
panel.background = element_rect(color = "transparent",
fill = "transparent"),
strip.background = element_rect(color = "transparent",
fill = "transparent"),
strip.text = element_text(size=12)) +
labs(title = "Over-the-Year Percent Change, Private Workers") +
ylab("Two-Digit NAICS") +
facet_wrap(Group ~ .) +
guides(fill = FALSE)
change %>%
ggplot(aes(y = industry_code,
x = Percent,
fill = Group)) +
geom_col(position = position_dodge(0.8)) +
theme(legend.position = "right",
plot.title = element_text(size=14),
legend.title = element_text(size=12),
panel.background = element_rect(color = "transparent",
fill = "transparent"),
strip.background = element_rect(color = "transparent",
fill = "transparent"),
strip.text = element_text(size=12)) +
labs(title = "Over-the-Year Percent Change, Private Workers") +
ylab("Two-Digit NAICS") +
facet_wrap(Group ~ .) +
guides(fill = FALSE) +
transition_time(year_quarter) +
ease_aes('linear')
##########################################################################
# Animated map of establishments
# oty_qtrly_estabs_pct_chg, oty_taxable_qtrly_wages_pct_chg, oty_qtrly_contributions_pct_chg
quant_01 <- as.numeric(quantile(QCEW_industry$oty_qtrly_estabs_pct_chg,probs = .01))
quant_99 <- as.numeric(quantile(QCEW_industry$oty_qtrly_estabs_pct_chg,probs = .99))
dynamic <- QCEW_industry %>% mutate(year_quarter = year + qtr/4) %>%
select(fips,year_quarter,
oty_qtrly_estabs_pct_chg) %>%
filter(oty_qtrly_estabs_pct_chg>quant_01 & oty_qtrly_estabs_pct_chg<quant_99) %>%
na.omit() %>%
distinct()
plot <- plot_usmap(data = dynamic,
values = "oty_qtrly_estabs_pct_chg",
size = .1)  +
scale_fill_gradient2(name    = "Percent Change",
low = "red",
mid = "white",
high = "forestgreen",
midpoint = 0) +
theme(legend.position = "right",
plot.title = element_text(size=14),
legend.title = element_text(size=12),
panel.background = element_rect(color = "transparent",
fill = "transparent")) +
labs(title = "Over-the-Year Percent Change in Quarterly Establishments, Private Workers",
subtitle = 'Year - {as.integer(frame_time)}') +
transition_time(year_quarter) +
ease_aes('linear')
animate(plot,
height = 5,
width = 8.5,
units = "in",
res = 150,
end_pause = 10,
renderer = gifski_renderer())
